<?php
/**
 * @file
 * Mica Datasets Opal Variables
 */

function mica_datasets_variables_menu() {
  $items = array();
  $items['variable-opal-search'] = array(
    'title' => t('Datasets Opal variables'),
    'access callback' => TRUE,
    'page callback' => 'mica_datasets_variables_page',
    'page arguments' => array(1),
    'weight' => 5,
    'type' => MENU_LOCAL_ACTION,
    //   'file' => 'mica_datasets.pages.inc',
  );
  return $items;
}

function mica_datasets_variables_menu_local_tasks_alter(&$data, $router_item, $root_path) {

  $links = array();
  switch ($root_path) {
    case 'datasets':
    case 'node/%':
      $node = $router_item['page_arguments'][0];
      if ($node != NULL && isset($node->type) && $node->type === 'dataset') {
        if (node_access('update', $node)) {
          // variables
          $links['view-opal-variable'] = array(
            '#weight' => 30,
            '#theme' => 'menu_local_action',
            '#link' => array(
              'title' => t('Datasets Opal variables'),
              'href' => 'variable-opal-search' . '/' . $node->nid,
              'localized_options' => array(
                'attributes' => array(
                  'class' => 'highlight'
                )
              )
            ),

          );
        }
      }
      break;
  }
  $data['actions']['output'] = array_merge($data['actions']['output'], $links);
}

/**
 * Check node type (if provided) and node access.
 *
 * @param node $node
 * @param string $bundle
 * @param string $op
 */
function _mica_datasets_variables_node_access($node, $bundle = NULL, $op = 'update') {
  if (!is_object($node)) {
    $node = node_load($node);
  }
  // Make sure the user can view the original node content.
  if ($bundle != NULL) {
    return TRUE;
  }
  return node_access($op, $node);
}

function mica_datasets_variables_page($dataset_nid) {
  global $languages;
  if (isset($languages)) {
    $lang = $languages;
  }
  else {
    $lang = 'und';
  }
  ctools_add_js('mica_datasets_variables', 'mica_datasets_variables');
  $dataset_detail = node_load($dataset_nid);
  $dataset_wrapper = entity_metadata_wrapper('node', $dataset_nid);
  $studies = array();
  $rows[] = array();
  $popup_variab_detail = array();
  foreach ($dataset_wrapper->field_dataset_studies->getIterator() as $study) {
    dpm($study->nid->value());
    $nid = $study->nid->value();
    $opal_variabls = _mica_datasets_variables_get_opal_variables($dataset_nid, $nid);
    if (!empty($opal_variabls)) {
      $study_variabls[$nid] = $opal_variabls;
      foreach ($study_variabls[$nid]['variables'] as $variable) {

        $rows[] = array(
          l($variable['title'], 'javascript:void(0);', array(
            'attributes' => array(
              'id' => $variable['title'],
              'class' => array('modals', $variable['title'])
            ),
            'external' => TRUE
          )),
          !empty($variable['label'][$lang]) ? $variable['label'][$lang] : '',
          $dataset_detail->title
        );
        $popup_variab_detail[] = _mica_datasets_variables_prepare_modal($variable);

      }
    }
  }
  dpm($study_variabls);
  $output = '';
  // Table construct
  $header = array('Name', 'Label', 'Dataset');
  $per_page = 20;
  $current_page = pager_default_initialize(count($rows), $per_page);
  $chunks = array_chunk($rows, $per_page, TRUE);
  $output .= '<br/>';

  $output .= theme(
      'table',
      array(
        'header' => $header,
        'rows' => $chunks[$current_page],
        'empty' => t('No data found'),
        'sticky' => FALSE,
        'attributes' => array('id' => 'variables_overview')
      )
    ) . theme('pager', array('quantity', count($rows)));

  //generate title of page :
  drupal_set_title('Datasets Opal variables' . $dataset_detail->title);
// generate specific breadcrumbs for study variable pages
  $breadcrumb = _mica_datasets_menu_generate_breadcrumbs_variables('node/' . $dataset_nid);
  $breadcrumbs = array();
  $breadcrumbs[] = l('Home', '');
  for ($i = 0; $i < count($breadcrumb); $i++) {
    $breadcrumbs[] = l(truncate_utf8($breadcrumb[$i]['link_title'], 45, TRUE, TRUE), $breadcrumb[$i]['link_path']);
  }
  drupal_set_breadcrumb($breadcrumbs);
  $events_details = '<div class=""modals>' . implode(' ', $popup_variab_detail) . '</div>';
  // The $delta parameter tells us which block is being requested.
  return '<div id=\'Variables_opal\'>' . $output . '</div>' . $events_details;
}

function mica_datasets_variables_block_info() {
  $blocks['opal_variables'] = array(
    // info: The name of the block.
    'info' => t('Current search'),
    'status' => TRUE,
    'region' => 'sidebar_first',
  );
  return $blocks;
}

function mica_datasets_variables_block_view($delta) {

  switch ($delta) {
    case 'opal_variables':
      // Create your block content here
      $block['subject'] = t('Current search');
      $block['content'] = 'Your block content, or the result of a function that returns the content';
      break;
  }

  return $block;
}

function _mica_datasets_variables_prepare_modal($variable) {
  global $languages;
  $lang = isset($languages) ? $languages : 'und';
  $tab = t('No categories for this Variables');

  if (!empty($variable['categories'])) {
    $rows_cat = array();
    $header_categ = array('Name', 'Label', 'Missing');
    foreach ($variable['categories'] as $val_categ) {
      $rows_cat[] = array($val_categ['name'], $val_categ['label'][$lang], $val_categ['missing']);
    }

    $tab = theme(
      'table',
      array(
        'header' => $header_categ,
        'rows' => $rows_cat,
        'empty' => t('No data found'),
        'sticky' => FALSE,
        'attributes' => array('id' => 'variables_overview')
      )
    );
  }

  $body2 = '<strong>Description</strong></br>';
  $body2 .= t('Label') . ' :' . $variable['label'][$lang] . '</br>';
  $body2 .= t('Value Type') . ' :' . $variable['value_type'] . '</br>';
  $body2 .= t('Repeatable') . ' :' . _mica_datasets_variables_repeatable($variable['repeatable']) . '</br>';
  $body2 .= t('categories') . ' :' . $tab . '</br>';

  return '<div id="event-' . $variable['title'] . '" class="modal hide fade">'
  . '<div class="modal-header"><h3>' . $variable['title'] . '</h3></div>'
  . '<div class="modal-body">' . $body2 . '</div>'
  . '<div class="modal-footer"><button class="btn" data-dismiss="modal" aria-hidden="true">' . t('Close') . '</button></div>'
  . '</div>';
}

function _mica_datasets_variables_repeatable($variable) {
  if (isset($variable) && $variable == 1) {
    return t('Yes');
  }
  else {
    return t('No');
  }
}

function _mica_datasets_variables_get_opal_variables($dataset_nid, $study_nid) {
  try {
    return mica_datasets_variables_get($dataset_nid, $study_nid);
  } catch (Exception $e) {
    $study_wrapper = entity_metadata_wrapper('node', $study_nid);
    $study_title = $study_wrapper->title->value();
    switch ($e->getCode()) {
      case 404:
        drupal_set_message(
          t('Opal server was not found (error 404) for study %study.',
            array('%study' => $study_title)),
          'error'
        );
        break;
      default:
        drupal_set_message(
          t('Error while importing variables for study %study: %error',
            array('%study' => $study_title, '%error' => $e->getMessage())),
          'error'
        );
    }
  }
  return NULL;
}

function mica_datasets_variables_get($dataset_nid, $study_nid) {

  $connector = mica_connector_query($dataset_nid, $study_nid, TRUE);

  if ($connector) {
    $opal = new MicaDatasetOpalConnectionClass($connector);
    $post = new HttpClientRequest($connector->__call("getTableResourceURI", array("variables")), array(
      'method' => 'GET',
      'headers' => array('Accept' => array('application/json')),
      'data' => array(),
      'parameters' => array(),
    ));
    $raw = $opal->client()->execute($post);

    $array = json_decode($raw, TRUE);
    // Support JSON lines format.r
    if (!is_array($array)) {
      $raw = preg_replace('/}\s*{/', '},{', $raw);
      $raw = '[' . $raw . ']';
      $array = json_decode($raw, TRUE);
    }

    if (is_array($array)) {
      $harmonization = array();
      $harmonization['dataset_nid'] = $dataset_nid;
      $harmonization['study_nid'] = $study_nid;

      $all_items = mica_opal_jsonPath($array, '$.*');
      unset($array);

      $harmonization = _mica_datasets_variables_itirate_detail_variables($all_items);
      return $harmonization;
    }
    throw new Exception(t('There was an error decoding the JSON document.'));
  }

  return FALSE;
}

function _mica_datasets_variables_itirate_detail_variables($all_items) {
  $harmonization = array();
  foreach ($all_items as $item) {

    $variable_info = array();

    // Check if uuid is present
    $variable_info['uuid'] = _mica_opal_json_get_string($item, 'attributes[?(@[\'name\']==\'uuid\'), ?(@[\'namespace\']==\'maelstrom\')].value');
    $variable_info['title'] = _mica_opal_json_get_string($item, 'name');
    $variable_info['label'] = _mica_opal_parse_localized($item, 'attributes[?(@[\'name\']==\'label\')]');
    $variable_info['value_type'] = _mica_opal_json_get_string($item, 'valueType');
    $variable_info['unit'] = _mica_opal_json_get_string($item, 'unit');

    $repeatable = _mica_opal_json_get_string($item, 'isRepeatable');
    // Explicitly set to 0 to avoid the error when saving an empty field into the database
    $variable_info['repeatable'] = empty($repeatable) ? '0' : $repeatable;

    $script = _mica_opal_json_get_string($item, 'attributes[?(@[\'name\'==\'script\' and @namespace == \'opal\'].value');
    $variable_info['script'] = strlen($script) === 0
      ? _mica_opal_json_get_string($item, 'attributes[?(@[\'name\']==\'script\')].value')
      : $script;

    $status = _mica_opal_json_get_string($item, 'attributes[?(@[\'name\']==\'status\'), ?(@[\'namespace\']==\'maelstrom\')].value');
    $variable_info['status'] = empty($status) || !strpos(",complete,impossible", $status) ? 'undetermined' : strtolower($status);

    $variable_info['description'] = _mica_opal_parse_localized($item, 'attributes[?(@[\'name\']==\'description\'), ?(@[\'namespace\']==\'maelstrom\')]');
    $variable_info['comment'] = _mica_opal_parse_localized($item, 'attributes[?(@[\'name\']==\'comment\'), ?(@[\'namespace\']==\'maelstrom\')]');

    $variable_info['categories'] = _mica_opal_parse_categories($item);

    $harmonization['variables'][$variable_info['title']] = $variable_info;

  }
  return $harmonization;

}